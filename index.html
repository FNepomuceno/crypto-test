<!doctype html>
<html>
<head>
<meta charset="UTF-8">
</head>
<body>
<script src="key.js"></script>
<script src="store.js"></script>
<script src="encrypt.js"></script>
<script>
(async function () {
  let {
    privateKey: aPrivate,
    publicKey: aPublic
  } = await generateEcKeypair()

  let aSecret = await deriveSecretKey(aPrivate, aPublic)

  let aData = window.crypto.getRandomValues(new Uint8Array(64))
  let {
    iv: aIv,
    encryptedData: aEncrypted
  } = await encryptAesGcm(aSecret, aData)
  let aDecrypted = await decryptAesGcm(aSecret, aEncrypted, aIv)
  let aDataHex = bufferToHex(aData)
  let aEncryptedHex = bufferToHex(aEncrypted)
  let aDecryptedHex = bufferToHex(aDecrypted)

  console.log(aPrivate, aPublic)
  console.log(aSecret)
  console.log(aDataHex, aEncryptedHex, aDecryptedHex)
  console.log(aDataHex === aDecryptedHex)

  function bufferToHex(buffer) {
    let data = Array.from(new Uint8Array(buffer))
    return data.map(x => x.toString(16).padStart(2, '0')).join('')
  }
})()
</script>
</body>
</html>
